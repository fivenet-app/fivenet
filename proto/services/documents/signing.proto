syntax = "proto3";

package services.documents;

import "buf/validate/validate.proto";
import "codegen/itemslen/itemslen.proto";
import "codegen/perms/perms.proto";
import "resources/common/database/database.proto";
import "resources/documents/signing.proto";
import "resources/documents/stamp.proto";
import "resources/timestamp/timestamp.proto";

option go_package = "github.com/fivenet-app/fivenet/v2025/gen/go/proto/services/documents;documents";

message ListSignaturePoliciesRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];
  resources.timestamp.Timestamp snapshot_date = 2 [(buf.validate.field).required = true];
}

message ListSignaturePoliciesResponse {
  repeated resources.documents.SignaturePolicy policies = 1 [(codegen.itemslen.enabled) = true];
}

message UpsertSignaturePolicyRequest {
  resources.documents.SignaturePolicy policy = 1 [(buf.validate.field).required = true];
}

message UpsertSignaturePolicyResponse {
  resources.documents.SignaturePolicy policy = 1;
}

message DeleteSignaturePolicyRequest {
  int64 policy_id = 1 [(buf.validate.field).int64.gt = 0];
}

message DeleteSignaturePolicyResponse {}

message ListSignaturesRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];

  resources.timestamp.Timestamp snapshot_date = 3 [(buf.validate.field).required = true];
  repeated resources.documents.SignatureStatus statuses = 4 [(buf.validate.field).repeated.max_items = 4];
}

message ListSignaturesResponse {
  repeated resources.documents.Signature signatures = 1 [(codegen.itemslen.enabled) = true];
}

message ApplySignatureRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];
  optional resources.timestamp.Timestamp snapshot_date = 2 [(buf.validate.field).required = true];
  int64 policy_id = 3; // 0/omit for acknowledgement

  resources.documents.SignatureType type = 4 [(buf.validate.field).enum.defined_only = true];
  optional string payload_svg = 5 [(buf.validate.field).string.min_len = 1];
  optional int64 stamp_id = 6; // when type=STAMP
}

message ApplySignatureResponse {
  resources.documents.Signature signature = 1;
  bool document_signed = 2;
}

message RevokeSignatureRequest {
  int64 signature_id = 1 [(buf.validate.field).int64.gt = 0];
  string reason = 2 [(buf.validate.field).string.max_len = 255];
}

message RevokeSignatureResponse {
  resources.documents.Signature signature = 1;
}

// Stamps listing â€” your example wired in as a method
message ListUsableStampsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(buf.validate.field).required = true];
  int64 document_id = 2;
}

message ListUsableStampsResponse {
  resources.common.database.PaginationResponse pagination = 1 [(buf.validate.field).required = true];
  repeated resources.documents.Stamp stamps = 2 [(codegen.itemslen.enabled) = true];
}

message UpsertStampRequest {
  resources.documents.Stamp stamp = 1 [(buf.validate.field).required = true];
}

message UpsertStampResponse {
  resources.documents.Stamp stamp = 1;
}

message DeleteStampRequest {
  int64 stamp_id = 1 [(buf.validate.field).int64.gt = 0];
}

message DeleteStampResponse {}

message RecomputeSignatureStatusRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];
  resources.timestamp.Timestamp snapshot_date = 2 [(buf.validate.field).required = true];
}

message RecomputeSignatureStatusResponse {
  bool document_signed = 1;
  int32 required_total = 2;
  int32 required_remaining = 3;
  int32 collected_valid = 4;
}

service SigningService {
  option (codegen.perms.perms_svc) = {
    order: 57
    icon: "i-mdi-signature"
  };

  // Requirements
  rpc ListSignaturePolicies(ListSignaturePoliciesRequest) returns (ListSignaturePoliciesResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "documents.DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc UpsertSignaturePolicy(UpsertSignaturePolicyRequest) returns (UpsertSignaturePolicyResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }
  rpc DeleteSignaturePolicy(DeleteSignaturePolicyRequest) returns (DeleteSignaturePolicyResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }

  // Signatures
  rpc ListSignatures(ListSignaturesRequest) returns (ListSignaturesResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "documents.DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc ApplySignature(ApplySignatureRequest) returns (ApplySignatureResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "documents.DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc RevokeSignature(RevokeSignatureRequest) returns (RevokeSignatureResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "DeleteSignaturePolicy"
    };
  }

  // Stamps
  rpc ListUsableStamps(ListUsableStampsRequest) returns (ListUsableStampsResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "documents.DocumentsService"
      name: "ListDocuments"
    };
  }

  rpc UpsertStamp(UpsertStampRequest) returns (UpsertStampResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }

  rpc DeleteStamp(DeleteStampRequest) returns (DeleteStampResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }

  // Helpers
  rpc RecomputeSignatureStatus(RecomputeSignatureStatusRequest) returns (RecomputeSignatureStatusResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "DeleteSignaturePolicy"
    };
  }
}
