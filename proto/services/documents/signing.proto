syntax = "proto3";

package services.documents;

import "buf/validate/validate.proto";
import "codegen/itemslen/itemslen.proto";
import "codegen/perms/perms.proto";
import "resources/common/database/database.proto";
import "resources/documents/signing.proto";
import "resources/timestamp/timestamp.proto";

option go_package = "github.com/fivenet-app/fivenet/v2025/gen/go/proto/services/documents;documents";

message ListRequirementsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(buf.validate.field).required = true];
  int64 document_id = 2 [(buf.validate.field).int64.gt = 0];
  resources.timestamp.Timestamp snapshot_date = 3 [(buf.validate.field).required = true];
}

message ListRequirementsResponse {
  resources.common.database.PaginationResponse pagination = 1 [(buf.validate.field).required = true];
  repeated resources.documents.SignatureRequirement requirements = 2 [(codegen.itemslen.enabled) = true];
}

message UpsertRequirementRequest {
  resources.documents.SignatureRequirement requirement = 1 [(buf.validate.field).required = true];
}

message UpsertRequirementResponse {
  resources.documents.SignatureRequirement requirement = 1;
}

message DeleteRequirementRequest {
  int64 requirement_id = 1 [(buf.validate.field).int64.gt = 0];
}

message DeleteRequirementResponse {}

message ListRequirementAccessRequest {
  int64 requirement_id = 1 [(buf.validate.field).int64.gt = 0];
}

message ListRequirementAccessResponse {
  resources.documents.SignatureAccess access = 1;
}

message UpsertRequirementAccessRequest {
  int64 requirement_id = 1 [(buf.validate.field).int64.gt = 0];
  resources.documents.SignatureAccess access = 2 [(buf.validate.field).required = true];
}

message UpsertRequirementAccessResponse {
  resources.documents.SignatureAccess access = 1;
}

message DeleteRequirementAccessRequest {
  int64 id = 1 [(buf.validate.field).int64.gt = 0];
}

message DeleteRequirementAccessResponse {}

message ListSignaturesRequest {
  resources.common.database.PaginationRequest pagination = 1 [(buf.validate.field).required = true];
  int64 document_id = 2 [(buf.validate.field).int64.gt = 0];
  resources.timestamp.Timestamp snapshot_date = 3 [(buf.validate.field).required = true];
  repeated resources.documents.SignatureStatus statuses = 4 [(buf.validate.field).repeated.max_items = 4];
}

message ListSignaturesResponse {
  resources.common.database.PaginationResponse pagination = 1 [(buf.validate.field).required = true];
  repeated resources.documents.Signature signatures = 2 [(codegen.itemslen.enabled) = true];
}

message ApplySignatureRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];
  optional resources.timestamp.Timestamp snapshot_date = 2 [(buf.validate.field).required = true];
  int64 requirement_id = 3; // 0/omit for acknowledgement
  resources.documents.SignatureType type = 4 [(buf.validate.field).enum.defined_only = true];
  string payload_json = 5 [(buf.validate.field).string.min_len = 1];
  int64 stamp_id = 6; // when type=STAMP
  string idempotency_key = 10 [(buf.validate.field).string.max_len = 64];
}

message ApplySignatureResponse {
  resources.documents.Signature signature = 1;
  bool document_signed = 2;
}

message RevokeSignatureRequest {
  int64 signature_id = 1 [(buf.validate.field).int64.gt = 0];
  string reason = 2 [(buf.validate.field).string.max_len = 255];
}

message RevokeSignatureResponse {
  resources.documents.Signature signature = 1;
}

message RecomputeSignatureStatusRequest {
  int64 document_id = 1 [(buf.validate.field).int64.gt = 0];
  resources.timestamp.Timestamp snapshot_date = 2 [(buf.validate.field).required = true];
}

message RecomputeSignatureStatusResponse {
  bool document_signed = 1;
  int32 required_total = 2;
  int32 required_remaining = 3;
  int32 collected_valid = 4;
}

// Stamps listing â€” your example wired in as a method
message ListUsableStampsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(buf.validate.field).required = true];
  int64 document_id = 2;
}

message ListUsableStampsResponse {
  resources.common.database.PaginationResponse pagination = 1 [(buf.validate.field).required = true];
  repeated resources.documents.Stamp stamps = 2 [(codegen.itemslen.enabled) = true];
}

service SigningService {
  option (codegen.perms.perms_svc) = {
    order: 57
    icon: "i-mdi-signature"
  };

  // Requirements
  rpc ListRequirements(ListRequirementsRequest) returns (ListRequirementsResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc UpsertRequirement(UpsertRequirementRequest) returns (UpsertRequirementResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }
  rpc DeleteRequirement(DeleteRequirementRequest) returns (DeleteRequirementResponse) {
    option (codegen.perms.perms) = {enabled: true};
  }

  // Requirement ACL
  rpc ListRequirementAccess(ListRequirementAccessRequest) returns (ListRequirementAccessResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc UpsertRequirementAccess(UpsertRequirementAccessRequest) returns (UpsertRequirementAccessResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "UpsertRequirement"
    };
  }
  rpc DeleteRequirementAccess(DeleteRequirementAccessRequest) returns (DeleteRequirementAccessResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "UpsertRequirement"
    };
  }

  // Signatures
  rpc ListSignatures(ListSignaturesRequest) returns (ListSignaturesResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc ApplySignature(ApplySignatureRequest) returns (ApplySignatureResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "DocumentsService"
      name: "ListDocuments"
    };
  }
  rpc RevokeSignature(RevokeSignatureRequest) returns (RevokeSignatureResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "DeleteRequirement"
    };
  }

  // Helpers
  rpc RecomputeSignatureStatus(RecomputeSignatureStatusRequest) returns (RecomputeSignatureStatusResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      name: "DeleteRequirement"
    };
  }

  // Stamps
  rpc ListUsableStamps(ListUsableStampsRequest) returns (ListUsableStampsResponse) {
    option (codegen.perms.perms) = {
      enabled: true
      service: "DocumentsService"
      name: "ListDocuments"
    };
  }
}
