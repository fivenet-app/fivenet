syntax = "proto3";

package resources.documents;

import "buf/validate/validate.proto";
import "codegen/dbscanner/dbscanner.proto";
import "resources/timestamp/timestamp.proto";
import "resources/users/users.proto";
import "tagger/tagger.proto";

option go_package = "github.com/fivenet-app/fivenet/v2025/gen/go/proto/resources/documents;documents";

enum SignatureBindingMode {
  SIGNATURE_BINDING_MODE_UNSPECIFIED = 0;
  // Invalidates on content edits
  SIGNATURE_BINDING_MODE_BINDING = 1;
  // Stays but marked 'signed on vX'
  SIGNATURE_BINDING_MODE_NONBINDING = 2;
}

enum SignatureType {
  SIGNATURE_TYPE_UNSPECIFIED = 0;
  SIGNATURE_TYPE_FREEHAND = 1;
  SIGNATURE_TYPE_TYPED = 2;
  SIGNATURE_TYPE_STAMP = 3;
}

message SignatureTypes {
  option (codegen.dbscanner.dbscanner) = {enabled: true};

  repeated SignatureType types = 1 [(buf.validate.field).repeated = {
    max_items: 3
    items: {
      enum: {defined_only: true}
    }
  }];
}

enum SignatureAccessLevel {
  SIGNATURE_ACCESS_LEVEL_UNSPECIFIED = 0;
  SIGNATURE_ACCESS_LEVEL_BLOCKED = 1;
  SIGNATURE_ACCESS_LEVEL_SIGN = 2;
}

message SignatureAccess {
  repeated SignatureJobAccess jobs = 1 [
    (buf.validate.field).repeated.max_items = 20,
    (tagger.tags) = "alias:\"job_access\""
  ];
  repeated SignatureUserAccess users = 2 [
    (buf.validate.field).repeated.max_items = 20,
    (tagger.tags) = "alias:\"user_access\""
  ];
}

message SignatureJobAccess {
  int64 id = 1;
  optional resources.timestamp.Timestamp created_at = 2;
  int64 target_id = 3;
  string job = 4 [(buf.validate.field).string.max_len = 20];
  optional string job_label = 5 [(buf.validate.field).string.max_len = 50];
  int32 minimum_grade = 6 [(buf.validate.field).int32.gte = 0];
  optional string job_grade_label = 7 [(buf.validate.field).string.max_len = 50];
  SignatureAccessLevel access = 8 [(buf.validate.field).enum.defined_only = true];
}

message SignatureUserAccess {
  int64 id = 1;
  optional resources.timestamp.Timestamp created_at = 2;
  int64 target_id = 3;
  int32 user_id = 4 [(buf.validate.field).int32.gt = 0];
  optional resources.users.UserShort user = 5;
  SignatureAccessLevel access = 6 [(buf.validate.field).enum.defined_only = true];
  optional bool required = 7;
}

message SignatureRequirement {
  int64 id = 1;
  int64 document_id = 2;

  resources.timestamp.Timestamp snapshot_date = 3;

  // "Leader", "Counterparty Rep"
  string label = 4;
  bool required = 5;

  SignatureBindingMode binding_mode = 6 [(buf.validate.field).enum.defined_only = true];
  SignatureTypes allowed_types = 7;

  SignatureAccess access = 8;

  resources.timestamp.Timestamp created_at = 9;
  resources.timestamp.Timestamp updated_at = 10;
}

enum SignatureStatus {
  SIGNATURE_STATUS_UNSPECIFIED = 0;
  SIGNATURE_STATUS_VALID = 1;
  SIGNATURE_STATUS_REVOKED = 2;
  SIGNATURE_STATUS_INVALID = 3;
}

message Signature {
  int64 id = 1;
  int64 document_id = 2;
  // version_id whose hash was shown
  resources.timestamp.Timestamp snapshot_date = 3;
  // Null/Empty for optional acknowledgements
  optional int64 requirement_id = 4;

  int32 user_id = 5;
  optional resources.users.UserShort user = 6;
  string job = 7 [(buf.validate.field).string.max_len = 20];
  optional string job_label = 8 [(buf.validate.field).string.max_len = 50];

  SignatureType type = 9 [(buf.validate.field).enum.defined_only = true];
  // SVG path, typed preview, stamp fill, etc.
  string payload_json = 10;
  // if type == STAMP
  optional int64 stamp_id = 11;

  SignatureStatus status = 12 [(buf.validate.field).enum.defined_only = true];
  // Revoke/Invalid reason
  optional string reason = 13;

  resources.timestamp.Timestamp created_at = 14;
  optional resources.timestamp.Timestamp revoked_at = 15;
}

// Stamps
enum StampAccessLevel {
  STAMP_ACCESS_LEVEL_UNSPECIFIED = 0;
  STAMP_ACCESS_LEVEL_BLOCKED = 1;
  STAMP_ACCESS_LEVEL_USE = 2;
  STAMP_ACCESS_LEVEL_MANAGE = 3;
}

message Stamp {
  int64 id = 1;
  string job = 2 [(buf.validate.field).string.max_len = 20];
  optional string job_label = 3;
  int32 owner_id = 4;
  resources.timestamp.Timestamp created_at = 5;

  // Parameterized SVG with slots
  string svg_template = 6;

  StampAccess access = 7;
}

message StampAccess {
  repeated StampJobAccess jobs = 1 [
    (buf.validate.field).repeated.max_items = 20,
    (tagger.tags) = "alias:\"job_access\""
  ];
}

message StampJobAccess {
  int64 id = 1;
  optional resources.timestamp.Timestamp created_at = 2;
  int64 target_id = 3;
  string job = 4 [(buf.validate.field).string.max_len = 20];
  optional string job_label = 5 [(buf.validate.field).string.max_len = 50];
  int32 minimum_grade = 6 [(buf.validate.field).int32.gte = 0];
  optional string job_grade_label = 7 [(buf.validate.field).string.max_len = 50];
  StampAccessLevel access = 8 [(buf.validate.field).enum.defined_only = true];
}
